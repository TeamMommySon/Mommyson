<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sd.mommyson.member.dao.MemberDAO">
	<resultMap type="com.sd.mommyson.member.dto.UserDTO" id="userResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="name" column="NAME"/>
		<result property="repCount" column="REP_COUNT"/>
	</resultMap>

	<resultMap type="com.sd.mommyson.member.dto.ManagerDTO" id="managerResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="lastLogin" column="LAST_LOGIN"/>
		<association property="authDTO" resultMap="authResultMap"/>
	</resultMap>

	<resultMap type="com.sd.mommyson.member.dto.AuthDTO" id="authResultMap">
		<id property="code" column="CODE"/>
		<result property="auth" column="AUTH"/>
	</resultMap>

	<resultMap type="com.sd.mommyson.member.dto.CeoDTO" id="ceoResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="account" column="ACCOUNT"/>
		<result property="no" column="STORE_NO"/>
		<result property="name" column="CEO_NAME"/>
		<association property="store" resultMap="storeResultMap"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.StoreDTO" id="storeResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="storeName" column="STORE_NAME"/>
		<result property="storeImg" column="STORE_IMG"/>
		<result property="storeInfo" column="STORE_INFO"/>
		<result property="grade" column="GRADE"/>
		<result property="delCost" column="DEL_COST"/>
		<result property="workTime" column="WORK_TIME"/>
		<result property="rvCount" column="COUNT"/>
		<result property="statusYN" column="STATUS_YN"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.MemberDTO" id="memberResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="email" column="EMAIL"/>
		<result property="memPwd" column="MEM_PWD"/>
		<result property="address" column="ADDRESS"/>
		<result property="postCode" column="POST_CODE"/>
		<result property="dAddress" column="D_ADDRESS"/>
		<result property="phone" column="PHONE"/>
		<result property="memType" column="MEM_TYPE"/>
		<result property="locationCode" column="LOCATION_CODE"/>
		<result property="nickname" column="NICKNAME"/>
		<result property="memId" column="MEM_ID"/>
		<result property="enrollDate" column="ENROLL_DATE"/>
		<result property="isDeleted" column="IS_DELETED"/>
		<association property="user" resultMap="userResultMap"/>
		<association property="ceo" resultMap="ceoResultMap"/>
		<association property="manager" resultMap="managerResultMap"/>

	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.EmailCodeDTO" id="emailCodeResultMap">
		<id property="code" column="CODE"/>
		<result property="emailCode" column="EMAIL_CODE"/>
		<association property="memCode" resultMap="memberResultMap"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.LocationDTO" id="locationResultMap" extends="memberResultMap">
		<id property="locationCode" column="LOCATION_CODE"/>
		<result property="locationName" column="LOCATION_NAME"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.owner.dto.TagDTO" id="tagResultMap">
		<id property="tagNo" column="TAG_NO"/>
		<result property="tagName" column="TAG"/>
		<result property="status" column="STATUS"/>
	</resultMap>

	<select id="selectAll" resultType="_int">
		SELECT * FROM TEST
	</select>
	
	<select id="selectEncPassword" resultType="String">
		SELECT 
			   A.MEM_PWD
		  FROM MEMBER_TBL A
		 WHERE A.MEM_ID = #{ memId }
	</select>
	
	<select id="selectMember" resultMap="memberResultMap">
		SELECT 
			   A.MEM_CODE
			 , A.EMAIL
			 , A.ADDRESS
			 , A.POST_CODE
			 , A.D_ADDRESS
			 , A.PHONE
			 , A.MEM_TYPE
			 , A.LOCATION_CODE
			 , A.NICKNAME
			 , A.MEM_ID
			 , A.ENROLL_DATE
			 , B.NAME
			 , B.REP_COUNT
			 , C.MEM_CODE
		     , C.ACCOUNT
			 , C.STORE_NO
			 , C.CEO_NAME
			 , D.STORE_IMG
			 , D.STORE_NAME
			 , D.STATUS_YN
			 , E.LAST_LOGIN
			 , E.CODE
		  FROM MEMBER_TBL A
		  LEFT JOIN USER_TBL B ON (A.MEM_CODE = B.MEM_CODE)
		  LEFT JOIN CEO_TBL C ON (A.MEM_CODE = C.MEM_CODE)
		  LEFT JOIN STORE_TBL D ON (A.MEM_CODE = D.MEM_CODE)
		  LEFT JOIN MANAGER_TBL E ON (A.MEM_CODE = E.MEM_CODE)
		 WHERE A.IS_DELETED = 'N'
		   AND A.MEM_ID = #{ memId }
	</select>
	
	<select id="selectLocation" resultType="hashmap">
		SELECT 
			   A.LOCATION_CODE
			 , A.LOCATION_NAME
		  FROM LOCATION A
		 WHERE A.LOCATION_CODE != 'L0'
	</select>
	
	<select id="selectCategoryList" resultType="hashmap">
		SELECT 
			   A.CATEGORY_CODE
			 , A.CATEGORY_NAME
		  FROM CATEGORY_TBL A
	</select>
	
	<select id="selectOwner" resultMap="memberResultMap">
		SELECT
		     	A.MEM_CODE
		     ,  A.ADDRESS
		     ,  A.POST_CODE
		     ,  A.D_ADDRESS
		     ,  A.PHONE
		     ,  A.LOCATION_CODE
		     ,  A.NICKNAME
		     ,  B.ACCOUNT
		     ,  B.STORE_NO
		     ,  B.CEO_NAME
		     ,  C.STORE_NAME
		     ,  C.STORE_IMG
		     ,  C.STORE_INFO
		     ,  C.WORK_TIME
		  FROM  MEMBER_TBL A
		  LEFT  JOIN CEO_TBL B ON(A.MEM_CODE = B.MEM_CODE)
		  LEFT  JOIN STORE_TBL C ON(B.MEM_CODE = C.MEM_CODE)
	     WHERE  A.IS_DELETED = 'N'
		   AND  A.MEM_ID = #{ memId }
    </select>
    
	<select id="selectManagers" parameterType="string" resultMap="memberResultMap">
		SELECT
			   A.MEM_CODE
			 , A.MEM_ID
			 , A.ENROLL_DATE
			 , B.LAST_LOGIN
			 , C.AUTH
		  FROM MEMBER_TBL A
		  LEFT JOIN MANAGER_TBL B ON(A.MEM_CODE = B.MEM_CODE)
		  LEFT JOIN AUTH_TBL C ON (B.CODE = C.CODE)
		 WHERE A.MEM_ID != #{ memId }
		   AND A.MEM_TYPE = 'manager'
		   AND A.IS_DELETED = 'N'
	</select>
	
	<!-- 아이디 중복 검사 -->
	<select id="idChk" resultType="int">
		SELECT COUNT(*) 
	      FROM MEMBER_TBL
	     WHERE MEM_ID = #{memId} 
	</select>
	
	<!-- 이메일 중복검사 -->
	<select id="emailChk" resultType="int">
		SELECT COUNT(*)
		  FROM MEMBER_TBL
		 WHERE EMAIL = #{ email } 
	</select>
	
	<!-- 지역코드 조회 -->
	<select id="locationCode" resultType="String">
		SELECT A.LOCATION_CODE
		  FROM LOCATION A
		 WHERE A.LOCATION_NAME = #{ locationName }
		  
	</select>
	
	<!--회원가입시 이메일 인증 코드 인설트 -->
	<insert id ="registEmailCode">
		INSERT 
		  INTO EMAIL_CODE_TBL
		(
		  CODE			
		, MEM_CODE
		, EMAIL_CODE
		)
		VALUES
		(
		  SEQ_CODE.NEXTVAL
		, null
		, #{ emailCode }
		)
	</insert>

	<!-- 소비자 회원가입 -->
	<!-- 사용자 회원가입 성공하면 MEMBER_TBL 의 memCode select -->
	<!-- order="AFTER" 삽입 후에 조회 -->
    <!-- INSERT 구문이 실행된 후, 방금 넣은 데이터의 ID를 조회하면 자동으로 DTO 객체에 설정됩니다.  -->
 	<insert id="customerJoin">
 	 
		INSERT ALL
		  INTO MEMBER_TBL
		VALUES
		( 
   		  SEQ_MEM_CODE.NEXTVAL
		, #{ email }
		, #{ memPwd }
		, #{ address }
		, #{ postCode }
		, #{ dAddress }
		, #{ phone }
		, 'user'
		, #{ locationCode }
		, #{ nickname }
		, #{ memId }
		, SYSDATE	
		, 'N'	
		)
		INTO USER_TBL 
		VALUES
		( 
		  SEQ_MEM_CODE.CURRVAL
		, #{ user.name }
		, 0
		)
		SELECT * FROM DUAL
	</insert>

	<select id="selectMemCode" resultType="_int">
	    SELECT MEM_CODE FROM (
		SELECT MEM_CODE FROM MEMBER_TBL 
		  ORDER BY ENROLL_DATE DESC)
		WHERE ROWNUM = 1
	</select>

	<!-- 회원가입 성공할 경우 이메일 인증 테이블 memCode 맞춰주기 -->
 	<update id="updateMemCode">
 		UPDATE EMAIL_CODE_TBL E
		   SET MEM_CODE = #{ memCode }
	</update>  
	
	<!-- 아이디 찾기 -->
	<select id="findIdCheck" resultType="String">
		SELECT MEM_ID
		  FROM MEMBER_TBL A
		  JOIN USER_TBL B ON(A.MEM_CODE = B.MEM_CODE)
		 WHERE A.EMAIL = #{ email }
	</select>
	
	<select id="selectTagList" resultMap="tagResultMap">
		SELECT
			   A.TAG_NO
			 , A.TAG
			 , A.STATUS
		  FROM TAGS_TBL A
		 WHERE A.STATUS = 'Y'
	</select>
	
	<resultMap type="com.sd.mommyson.owner.dto.ProductDTO" id="productResultMap">
		<id property="sdCode" column="SD_CODE"/>
    	<result property="sdName" column="SD_NAME"/>
    	<result property="mDate" column="M_DATE"/>
    	<result property="price" column="PRICE"/>
    	<result property="ingredient" column="INGREDIENT"/>
    	<result property="volume" column="VOLUME"/>
    	<result property="sdImg" column="SD_IMG"/>
    	<result property="category" column="CATEGORY"/>
    	<result property="discountRate" column="DISCOUNT_RATE"/>
    	<result property="memCode" column="MEM_CODE"/>
    	<result property="orderableStatus" column="ORDERABLE_STATUS"/>
    	<result property="eDate" column="EXPIRY_DATE"/>
    	<result property="categoryCode" column="CATEGORY_CODE"/>
    	<result property="storageMethod" column="STORAGE_METHOD"/>
    	<result property="detail" column="SD_DETAIL"/>
    	<result property="isDeleted" column="IS_DELETED"/>
    	<result property="storeName" column="STORE_NAME"/>
	</resultMap>
	
	<select id="selectProductList" resultMap="productResultMap">
		SELECT
    		   A.SD_CODE
    		 , A.SD_IMG
    		 , A.SD_NAME
    		 , A.SD_DETAIL
    		 , A.DISCOUNT_RATE
    		 , A.PRICE
    		 , A.ORDERABLE_STATUS
    		 , A.MEM_CODE
    		 , B.STORE_NAME
    	  FROM PRODUCT_TBL A
    	  JOIN STORE_TBL B ON(A.MEM_CODE = B.MEM_CODE)
    	 WHERE A.ORDERABLE_STATUS = 'Y'
    	   AND A.IS_DELETED = 'N'
	</select>
	
	<select id="selectHotKeywordList" resultMap="tagResultMap">
		SELECT
			   A.HOT_NO AS TAG_NO
			 , A.HOT_TAG AS TAG
		  FROM HOT_TBL A
	</select>
	
	<select id="selectStoreList" resultMap="storeResultMap">
		SELECT
			   A.MEM_CODE
			 , A.STORE_NAME
			 , A.STORE_IMG
			 , (SELECT COUNT(*) FROM STORE_TBL S LEFT JOIN REVIEW_TBL R ON(S.MEM_CODE = R.MEM_CODE)) AS COUNT
		  FROM STORE_TBL A
		  LEFT JOIN MEMBER_TBL M ON(A.MEM_CODE = M.MEM_CODE)
		 WHERE M.IS_DELETED = 'N'
		 ORDER BY M.ENROLL_DATE DESC
	</select>
	
	<!--비밀번호 찾기(변경 화면으로 이동 하기 전단계) 이메일 인증-->
	<update id ="updateEmailCode" parameterType="hashMap">
		UPDATE EMAIL_CODE_TBL A
		   SET A.EMAIL_CODE = #{ emailCode }
	     WHERE A.MEM_CODE = (SELECT MEM_CODE FROM MEMBER_TBL WHERE EMAIL = #{ email })
	</update> 
	
 	<!-- 비밀번호 변경하기 -->
 	<update id="modifyPwd" parameterType="hashMap">
 		UPDATE MEMBER_TBL A
 		   SET A.MEM_PWD = #{ encode }
 		 WHERE A.EMAIL = #{ email } 
 	</update>
 
	<update id="updateLastLogin">
		UPDATE MANAGER_TBL
		   SET LAST_LOGIN = SYSTIMESTAMP
		 WHERE MEM_CODE = (SELECT MEM_CODE FROM MEMBER_TBL WHERE MEM_ID = #{ memId })
	</update>
	
</mapper>