<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sd.mommyson.member.dao.MemberDAO">
	<resultMap type="com.sd.mommyson.member.dto.UserDTO" id="userResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="name" column="NAME"/>
		<result property="repCount" column="REP_COUNT"/>
	</resultMap>

	<resultMap type="com.sd.mommyson.member.dto.ManagerDTO" id="managerResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="lastLogin" column="LAST_LOGIN"/>
		<association property="authDTO" resultMap="authResultMap"/>
	</resultMap>

	<resultMap type="com.sd.mommyson.member.dto.AuthDTO" id="authResultMap">
		<id property="code" column="CODE"/>
		<result property="auth" column="AUTH"/>
	</resultMap>

	<resultMap type="com.sd.mommyson.member.dto.CeoDTO" id="ceoResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="account" column="ACCOUNT"/>
		<result property="no" column="STORE_NO"/>
		<result property="name" column="CEO_NAME"/>
		<association property="store" resultMap="storeResultMap"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.StoreDTO" id="storeResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="storeName" column="STORE_NAME"/>
		<result property="storeImg" column="STORE_IMG"/>
		<result property="storeInfo" column="STORE_INFO"/>
		<result property="grade" column="GRADE"/>
		<result property="delCost" column="DEL_COST"/>
		<result property="workTime" column="WORK_TIME"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.MemberDTO" id="memberResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="email" column="EMAIL"/>
		<result property="memPwd" column="MEM_PWD"/>
		<result property="address" column="ADDRESS"/>
		<result property="postCode" column="POST_CODE"/>
		<result property="dAddress" column="D_ADDRESS"/>
		<result property="phone" column="PHONE"/>
		<result property="memType" column="MEM_TYPE"/>
		<result property="locationCode" column="LOCATION_CODE"/>
		<result property="nickname" column="NICKNAME"/>
		<result property="memId" column="MEM_ID"/>
		<result property="enrollDate" column="ENROLL_DATE"/>
		<result property="isDeleted" column="IS_DELETED"/>
		<association property="user" resultMap="userResultMap"/>
		<association property="ceo" resultMap="ceoResultMap"/>
		<association property="manager" resultMap="managerResultMap"/>

	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.LocationDTO" id="locationResultMap" extends="memberResultMap">
		<id property="locationCode" column="LOCATION_CODE"/>
		<result property="locationName" column="LOCATION_NAME"/>
	</resultMap>

	<select id="selectAll" resultType="_int">
		SELECT * FROM TEST
	</select>
	
	<select id="selectEncPassword" resultType="String">
		SELECT 
			   A.MEM_PWD
		  FROM MEMBER_TBL A
		 WHERE A.MEM_ID = #{ memId }
	</select>
	
	<select id="selectMember" resultMap="memberResultMap">
		SELECT 
			   A.MEM_CODE
			 , A.EMAIL
			 , A.ADDRESS
			 , A.POST_CODE
			 , A.D_ADDRESS
			 , A.PHONE
			 , A.MEM_TYPE
			 , A.LOCATION_CODE
			 , A.NICKNAME
			 , A.MEM_ID
			 , A.ENROLL_DATE
			 , B.NAME
			 , B.REP_COUNT
			 , C.MEM_CODE
		     , C.ACCOUNT
			 , C.STORE_NO
			 , C.CEO_NAME
			 , D.STORE_IMG
			 , D.STORE_NAME
			 , E.LAST_LOGIN
			 , E.CODE
		  FROM MEMBER_TBL A
		  LEFT JOIN USER_TBL B ON (A.MEM_CODE = B.MEM_CODE)
		  LEFT JOIN CEO_TBL C ON (A.MEM_CODE = C.MEM_CODE)
		  LEFT JOIN STORE_TBL D ON (A.MEM_CODE = D.MEM_CODE)
		  LEFT JOIN MANAGER_TBL E ON (A.MEM_CODE = E.MEM_CODE)
		 WHERE A.IS_DELETED = 'N'
		   AND A.MEM_ID = #{ memId }
	</select>
	
	<select id="selectLocation" resultType="hashmap">
		SELECT 
			   A.LOCATION_CODE
			 , A.LOCATION_NAME
		  FROM LOCATION A
		 WHERE A.LOCATION_CODE != 'L0'
	</select>
	
	<select id="selectCategoryList" resultType="hashmap">
		SELECT 
			   A.CATEGORY_CODE
			 , A.CATEGORY_NAME
		  FROM CATEGORY_TBL A
	</select>
	
	<select id="selectOwner" resultMap="memberResultMap">
		SELECT
		     	A.MEM_CODE
		     ,  A.ADDRESS
		     ,  A.POST_CODE
		     ,  A.D_ADDRESS
		     ,  A.PHONE
		     ,  A.LOCATION_CODE
		     ,  A.NICKNAME
		     ,  B.ACCOUNT
		     ,  B.STORE_NO
		     ,  B.CEO_NAME
		     ,  C.STORE_NAME
		     ,  C.STORE_IMG
		     ,  C.STORE_INFO
		     ,  C.WORK_TIME
		  FROM  MEMBER_TBL A
		  LEFT  JOIN CEO_TBL B ON(A.MEM_CODE = B.MEM_CODE)
		  LEFT  JOIN STORE_TBL C ON(B.MEM_CODE = C.MEM_CODE)
	     WHERE  A.IS_DELETED = 'N'
		   AND  A.MEM_ID = #{ memId }
    </select>
    
	<select id="selectManagers" parameterType="string" resultMap="memberResultMap">
		SELECT
			   A.MEM_CODE
			 , A.MEM_ID
			 , A.ENROLL_DATE
			 , B.LAST_LOGIN
			 , C.AUTH
		  FROM MEMBER_TBL A
		  LEFT JOIN MANAGER_TBL B ON(A.MEM_CODE = B.MEM_CODE)
		  LEFT JOIN AUTH_TBL C ON (B.CODE = C.CODE)
		 WHERE A.MEM_ID != #{ memId }
		   AND A.MEM_TYPE = 'manager'
		   AND A.IS_DELETED = 'N'
	</select>
	
	<!-- 아이디 중복 검사 -->
	<select id="idChk" resultType="int">
		SELECT COUNT(*) 
	      FROM MEMBER_TBL
	     WHERE MEM_ID = #{memId} 
	</select>
	
	<!-- 이메일 중복검사 -->
	<select id="emailChk" resultType="int">
		SELECT COUNT(*)
		  FROM MEMBER_TBL
		 WHERE EMAIL = #{ email } 
	</select>
	
	<!-- 지역코드 조회 -->
	<select id="locationCode" resultType="String">
		SELECT A.LOCATION_CODE
		  FROM LOCATION A
		 WHERE A.LOCATION_NAME = #{ locationName }
		  
	</select>
 	<insert id="customerJoin">
		INSERT ALL
		  INTO MEMBER_TBL
		VALUES
		( 
   		  SEQ_MEM_CODE.NEXTVAL
		, #{ email }
		, #{ memPwd }
		, #{ address }
		, #{ postCode }
		, #{ dAddress }
		, #{ phone }
		, 'user'
		, #{ locationCode }
		, #{ nickname }
		, #{ memId }
		, SYSDATE	
		, 'N'	
		)
		INTO USER_TBL 
		VALUES
		( 
		  SEQ_MEM_CODE.CURRVAL
		, #{ user.name }
		, 0
		)
		SELECT * FROM DUAL
	</insert>
	<update id="updateLastLogin">
		UPDATE MANAGER_TBL
		   SET LAST_LOGIN = SYSTIMESTAMP
		 WHERE MEM_CODE = (SELECT MEM_CODE FROM MEMBER_TBL WHERE MEM_ID = #{ memId })
	</update>
	
	<select id="findIdCheck" resultType="String">
		SELECT MEM_ID
		  FROM MEMBER_TBL A
		  JOIN USER_TBL B ON(A.MEM_CODE = B.MEM_CODE)
		 WHERE A.EMAIL = #{ email }
		  
			
	</select>
</mapper>