<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.sd.mommyson.usermypage.dao.UserMyPageDAO">
    
<!-- 	<resultMap type="com.sd.mommyson.usermypage.dto.MyOrderDTO" id="MyOrderResultMap">
		<id property="" column=""/>
		<result property="memCode" column=""/>
		<result property="sdCode" column=""/>
		<result property="amount" column=""/>
		<result property="orderCode" column=""/>
		<result property="orderCompleteTime" column=""/>
		<result property="orderAcceptTime" column=""/>
		<result property="orderRequestTime" column=""/>
		<result property="sdName" column=""/>
		<result property="sdImg" column=""/>
		<result property="ownerCode" column=""/>
	</resultMap>  -->    
	
	<resultMap type="com.sd.mommyson.usermypage.dto.CouponDTO" id="couponResultMap">
		<id property="cpCode" column="CP_CODE"/>
		<result property="cpName" column="CP_NAME"/>
		<result property="startDate" column="START_DATE"/>
		<result property="disWon" column="DISCOUNT_WON"/>
		<result property="endDate" column="END_DATE"/>
		<result property="dCcon" column="DC_CONDITION"/>
		<association property="store" resultMap="storeResultMap"/>
		<association property="cpHistory" resultMap="cpHistoryResultMap"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.StoreDTO" id="storeResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="storeName" column="STORE_NAME"/>
		<result property="storeImg" column="STORE_IMG"/>
		<result property="storeInfo" column="STORE_INFO"/>
		<result property="grade" column="GRADE"/>
		<result property="delCost" column="DEL_COST"/>
		<result property="workTime" column="WORK_TIME"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.usermypage.dto.CouponHistoryDTO" id="cpHistoryResultMap">
		<id property="cpCode" column="CP_CODE"/>
		<id property="memCode" column="MEM_CODE"/>
		<result property="useStatus" column="USE_STATUS"/>
	</resultMap>
	
	<!-- 나의 사용가능한 쿠폰 총 갯수 확인 -->
	<select id="selectMycouponNo" resultType="_int" parameterType="hashmap">
	
		SELECT
			  COUNT(*)
		 FROM COUPON_TBL A
		 JOIN CP_HISTORY_TBL B ON(A.CP_CODE = B.CP_CODE)
		WHERE B.USE_STATUS = 'N'
		  AND B.MEM_CODE = #{ searchCondition }
		  <if test="searchValue != null">
		  AND A.CP_NAME LIKE '%' || #{ searchValue } || '%' 
		  </if>
		  <![CDATA[
		  AND SYSDATE <= A.END_DATE
		  ]]>
	</select>
    <!-- 내 쿠폰함 출력 -->
    <select id="selectMyCouponList" resultMap="couponResultMap">
    	SELECT
    		   A.RNUM	
    		 , A.CP_CODE
			 , A.CP_NAME
			 , A.START_DATE
			 , A.DISCOUNT_WON
			 , A.END_DATE
			 , A.DC_CONDITION
			 , A.STORE_NAME
			 , A.STORE_IMG
		 FROM (SELECT  ROWNUM RNUM	
		    		 , B.CP_CODE
					 , B.CP_NAME
					 , B.START_DATE
					 , B.DISCOUNT_WON
					 , B.END_DATE
					 , B.DC_CONDITION
					 , B.STORE_NAME
					 , B.STORE_IMG
				 FROM (SELECT  C.CP_CODE
							 , C.CP_NAME
							 , C.START_DATE
							 , C.DISCOUNT_WON
							 , C.END_DATE
							 , C.DC_CONDITION
							 , F.STORE_NAME
							 , F.STORE_IMG
				 		  FROM COUPON_TBL C
				 		  JOIN CP_HISTORY_TBL D ON (C.CP_CODE = D.CP_CODE)
				 		  JOIN COUPON_STORE_TBL E ON (C.CP_CODE = E.CP_CODE)
				 		  JOIN STORE_TBL F ON (E.MEM_CODE= F.MEM_CODE)
					 		   <where>
							 	  D.USE_STATUS = 'N'				 		  
					 		 	  <![CDATA[
					 		 	  AND SYSDATE <= C.END_DATE
					 		 	  ]]>
					 			  <if test="searchValue != null">
					 			  AND C.CP_NAME LIKE '%' || #{ searchValue } || '%'
					 			  </if>
					 		   </where>
					 		   ORDER BY C.END_DATE ASC
					 		   )B
					 	 <![CDATA[
					 	 WHERE ROWNUM <= #{ endRow }
					 	 ]]>
					 	 )A
			 <![CDATA[
			 WHERE A.RNUM >= #{ startRow }
			 ]]>		 	 	 
    </select>
    
    <!-- 나의 주문내역  -->
    <resultMap type="com.sd.mommyson.usermypage.dto.MyOrderDTO" id="myOrderResultMap">
    	<id property="orderCode" column="ORDER_CODE"/>
    	<result property="memCode" column="MEM_CODE"/>
    	<result property="totalPrice" column="TOTAL_PRICE"/>
    	<result property="orderType" column="ORDER_TYPE"/>
    	<result property="takeTime" column="TAKE_TIME"/>
    	<result property="address" column="ADDRESS"/>
    	<result property="phone" column="PHONE"/>
    	<result property="storeName" column="STORE_NAME"/>
    	<result property="code" column="CODE"/>
    	<result property="orderCancleTime" column="ORDER_CANCLE_TIME"/>
    	<result property="orderCompleteTime" column="ORDER_COMPLETE_TIME"/>
    	<result property="orderAcceptTime" column="ORDER_ACCEPT_TIME"/>
    	<result property="orderRequestTime" column="ORDER_RUQEUST_TIME"/>
    	<collection property="orderInfo" resultMap="orderInfoResultMap"/> 
    </resultMap>
    <resultMap type="com.sd.mommyson.usermypage.dto.OrderInfoDTO" id="orderInfoResultMap">
    	<id property="proNo" column="PRO_NO"/>
    	<result property="sdCode" column="SD_CODE"/>
    	<result property="amount" column="AMONT"/>
    	<result property="orderCode" column="ORDER_CODE"/>
    </resultMap>
    

    <!-- 나의 주문내역 총 갯수 확인 -->
    <select id="selectMyOrderNum" resultType="_int" parameterType="hashmap">
	SELECT
			  COUNT(*)
		 FROM ORDER_TBL A
		WHERE A.MEM_CODE = #{ searchCondition }
		  <if test="searchValue != null">
		  AND A.STORE_NAME LIKE '%' || #{ searchValue } || '%' 
		  </if>
	</select>
	
	<!-- 나의 주문목록 출력 및 페이지 네이션  -->
	<select id="selectMyOrderList" resultMap="myOrderResultMap">
		SELECT
		        A.RNUM
			  ,	A.MEM_CODE
			  , A.TOTAL_PRICE
			  ,	A.ORDER_CODE
			  ,	A.ORDER_TYPE
			  ,	A.TAKE_TIME
			  ,	A.ADDRESS
			  ,	A.PHONE
		   	  ,	A.STORE_NAME
		      ,	A.CODE
			  ,	A.ORDER_CANCLE_TIME
			  ,	A.ORDER_COMPLETE_TIME
			  ,	A.ORDER_ACCEPT_TIME
			  ,	A.ORDER_RUQEUST_TIME
			  , A.SD_CODE
		   FROM	(SELECT ROWNUM RNUM
					  ,	B.MEM_CODE
					  , B.TOTAL_PRICE
					  ,	B.ORDER_CODE
					  ,	B.ORDER_TYPE
					  ,	B.TAKE_TIME
					  ,	B.ADDRESS
					  ,	B.PHONE
				   	  ,	B.STORE_NAME
				      ,	B.CODE
					  ,	B.ORDER_CANCLE_TIME
					  ,	B.ORDER_COMPLETE_TIME
					  ,	B.ORDER_ACCEPT_TIME
					  ,	B.ORDER_RUQEUST_TIME
					  , B.SD_CODE
				   FROM (SELECT C.MEM_CODE
							  , C.TOTAL_PRICE
							  ,	C.ORDER_CODE
							  ,	C.ORDER_TYPE
							  ,	C.TAKE_TIME
							  ,	C.ADDRESS
							  ,	C.PHONE
						   	  ,	C.STORE_NAME
						      ,	C.CODE
							  ,	C.ORDER_CANCLE_TIME
							  ,	C.ORDER_COMPLETE_TIME
							  ,	C.ORDER_ACCEPT_TIME
							  ,	C.ORDER_RUQEUST_TIME
							  , D.SD_CODE
						   FROM ORDER_TBL C
						   JOIN ORDER_INFO_TBL D ON(D.ORDER_CODE=C.ORDER_CODE)
						   <where>
						   		C.MEM_CODE = #{ searchCondition }
						   		<if test="searchValue != null">
						   		C.STORE_NAME LIKE '%' || #{ searchValue } || '%'
						   		</if>
						   </where>
						   ORDER BY C.ORDER_RUQEUST_TIME DESC
						   )B
					 <![CDATA[
					 	 WHERE ROWNUM <= #{ endRow }
					 	 ]]>
					 	 )A
			 <![CDATA[
			 WHERE A.RNUM >= #{ startRow }
			 ]]>	   
	</select>
	
	    <!-- 내가 자주 찾는 가게 총 갯수 확인 -->
    <select id="selectMyRecommendStore" resultType="_int" parameterType="hashmap">
	SELECT
			  COUNT(*)
		 FROM JJIM_TBL A
		 JOIN CEO_TBL B ON(B.MEM_CODE = A.CEO_CODE)
		 JOIN STORE_TBL C ON(C.MEM_CODE = B.MEM_CODE)
		WHERE A.MEM_CODE = #{ searchCondition }
		  <if test="searchValue != null">
		  AND C.STORE_NAME LIKE '%' || #{ searchValue } || '%' 
		  </if>
	</select>
	
	<!-- 자주 찾는 가게 출력  -->
 	<select id="selectRecommendStore" resultMap="storeResultMap">
	SELECT
	       A.RNUM
	     , A.STORE_NAME
		 , A.STORE_IMG
		 , A.STORE_INFO
		 , A.GRADE
		 , A.DEL_COST
		 , A.WORK_TIME
		 , A.MEM_CODE
	  FROM (SELECT ROWNUM RNUM
			     , B.STORE_NAME
				 , B.STORE_IMG
				 , B.STORE_INFO
				 , B.GRADE
				 , B.DEL_COST
				 , B.WORK_TIME
				 , B.MEM_CODE
	   		  FROM (SELECT C.STORE_NAME
						 , C.STORE_IMG
						 , C.STORE_INFO
						 , C.GRADE
						 , C.DEL_COST
						 , C.WORK_TIME
						 , C.MEM_CODE
				 	  FROM STORE_TBL C
				 	  JOIN CEO_TBL D ON(C.MEM_CODE = D.MEM_CODE)
				 	  JOIN JJIM_TBL E ON(D.MEM_CODE = E.CEO_CODE)
				 	 WHERE E.MEM_CODE = #{ searchCondition }
				 	 <if test="searchValue != null">
				 	   AND C.STORE_NAME LIKE '%' || #{ searchValue } || '%'
				 	 </if>
				 	 ORDER BY STORE_NAME ASC
			  		 )B
			   <![CDATA[
			 	 WHERE ROWNUM <= #{ endRow }
			 	 ]]>
			 	 )A
	 <![CDATA[
	 WHERE A.RNUM >= #{ startRow }
	 ]]>	   
	</select>
    </mapper>
    