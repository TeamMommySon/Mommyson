<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sd.mommyson.manager.dao.ManagerDAO">

	<resultMap id="memberResultMap" type="com.sd.mommyson.member.dto.MemberDTO">
		<id property="memCode" column="MEM_CODE"/>
		<result property="email" column="EMAIL"/>
		<result property="memPwd" column="MEM_PWD"/>
		<result property="address" column="ADDRESS"/>
		<result property="postCode" column="POST_CODE"/>
		<result property="dAddress" column="D_ADDRESS"/>
		<result property="phone" column="PHONE"/>
		<result property="memType" column="MEM_TYPE"/>
		<result property="locationCode" column="LOCATION_CODE"/>
		<result property="nickname" column="NICKNAME"/>
		<result property="memId" column="MEM_ID"/>
		<result property="enrollDate" column="ENROLL_DATE"/>
		<result property="isDeleted" column="IS_DELETED"/>
		<collection property="user" resultMap="userResultMap"/>
		<collection property="ceo" resultMap="ceoResultMap"/>
		<collection property="manager" resultMap="managerResultMap"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.ManagerDTO" id="managerResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="lastLogin" column="LAST_LOGIN"/>
		<collection property="authDTO" resultMap="authResultMap"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.CeoDTO" id="ceoResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="account" column="ACCOUNT"/>
		<result property="no" column="STORE_NO"/>
		<result property="name" column="CEO_NAME"/>
		<collection property="store" resultMap="storeResultMap"></collection>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.StoreDTO" id="storeResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="storeName" column="STORE_NAME"/>
		<result property="storeImg" column="STORE_IMG"/>
		<result property="storeInfo" column="STORE_INFO"/>
		<result property="grade" column="GRADE"/>
		<result property="delCost" column="DEL_COST"/>
		<result property="workTime" column="WORK_TIME"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.AuthDTO" id="authResultMap">
		<id property="code" column="CODE"/>
		<result property="auth" column="AUTH"/>
	</resultMap>
	
	<resultMap type="com.sd.mommyson.member.dto.UserDTO" id="userResultMap">
		<id property="memCode" column="MEM_CODE"/>
		<result property="name" column="NAME"/>
		<result property="repCount" column="REP_COUNT"/>
	</resultMap>
	
	<select id="memberSelect" resultMap="memberResultMap">
	    SELECT 
			   A.MEM_CODE
			 , A.EMAIL
			 , A.ADDRESS
			 , A.POST_CODE
			 , A.D_ADDRESS
			 , A.PHONE
			 , A.MEM_TYPE
			 , A.LOCATION_CODE
			 , A.NICKNAME
			 , A.MEM_ID
			 , A.ENROLL_DATE
			 , A.IS_DELETED
			 , B.NAME
			 , B.REP_COUNT
			 , C.MEM_CODE
		     , C.ACCOUNT
			 , C.STORE_NO
			 , C.CEO_NAME
			 , D.STORE_NAME
			 , D.STORE_IMG
			 , D.STORE_INFO
			 , D.GRADE
			 , D.DEL_COST
			 , D.WORK_TIME
			 , D.MEM_CODE
		  FROM MEMBER_TBL A
		  LEFT JOIN USER_TBL B ON (A.MEM_CODE = B.MEM_CODE)
		  LEFT JOIN CEO_TBL C ON (A.MEM_CODE = C.MEM_CODE)
		  LEFT JOIN STORE_TBL D ON (A.MEM_CODE = D.MEM_CODE)
		 WHERE A.IS_DELETED = 'N'
	</select>
	
	<select id="blackMemberSelect" resultMap="memberResultMap">
	    SELECT 
			   A.MEM_CODE
			 , A.EMAIL
			 , A.ADDRESS
			 , A.POST_CODE
			 , A.D_ADDRESS
			 , A.PHONE
			 , A.MEM_TYPE
			 , A.LOCATION_CODE
			 , A.NICKNAME
			 , A.MEM_ID
			 , A.ENROLL_DATE
			 , A.IS_DELETED
		  FROM MEMBER_TBL A
		  LEFT JOIN USER_TBL B ON (A.MEM_CODE = B.MEM_CODE)
		  LEFT JOIN CEO_TBL C ON (A.MEM_CODE = C.MEM_CODE)
		  LEFT JOIN STORE_TBL D ON (A.MEM_CODE = D.MEM_CODE)
		 WHERE A.IS_DELETED = 'B'
	</select>
	
	<update id="deleteMembers" parameterType="list">
	    UPDATE
	           MEMBER_TBL A
	       SET A.IS_DELETED = 'Y'
	     <where>
	     	A.MEM_CODE IN
	     	<foreach collection="list" item="item" index="index" separator="," open="(" close=")">
	     		#{ item }
	     	</foreach>
	     </where>
	</update>
	
	<update id="memberAddBlack" parameterType="list">
		UPDATE
		       MEMBER_TBL A
		   SET A.IS_DELETED = 'B'
		 <where>
	     	A.MEM_CODE IN
	     	<foreach collection="list" item="item" index="index" separator="," open="(" close=")">
	     		#{ item }
	     	</foreach>
	   	 </where>
	</update>
	
	<select id="selectAuth" resultMap="authResultMap">
		SELECT
			   A.CODE
			 , A.AUTH
		  FROM AUTH_TBL A
		 WHERE A.CODE != 6
	</select>
	
	<update id="updateAuth" parameterType="hashmap">
		UPDATE MANAGER_TBL
		   SET CODE = #{ selected }
		 WHERE MEM_CODE = #{ memCode }
	</update>
	
	<insert id="insertNewManager" parameterType="hashmap">
		INSERT ALL
		INTO MEMBER_TBL VALUES(SEQ_MEMBER.nextval, NULL, #{ member.memPwd }, NULL, NULL, NULL, NULL, 'manager', 'L0', '관리자', #{ member.memId }, SYSDATE, 'N')
		INTO MANAGER_TBL VALUES(SEQ_MEMBER.currval, NULL, #{ code })
		SELECT * FROM DUAL
	</insert>
	
	<select id="selectManagerByMemCode" resultType="hashmap">
		SELECT
			   A.MEM_CODE
			 , A.MEM_ID
			 , B.CODE
		  FROM MEMBER_TBL A
		  JOIN MANAGER_TBL B ON(A.MEM_CODE = B.MEM_CODE)
		 WHERE A.MEM_CODE = #{ memCode }
	</select>
	
	<update id="deleteManager" parameterType="list">
		UPDATE MEMBER_TBL
		   SET IS_DELETED = 'Y'
		 WHERE MEM_CODE IN
		 <foreach collection="list" item="memCode" separator="," open="(" close=")">
		 	#{ memCode }
		 </foreach>
	</update>
   
   <resultMap id="PostResultMap" type="com.sd.mommyson.manager.dto.postDTO" >
 	  <id property="postNo" column="POST_NO"/>
   	  <result property="boardCode" column="BOARD_CODE"/>
   	  <result property="postTitle" column="POST_TITLE"/>
   	  <result property="memCode" column="MEM_CODE"/>
   	  <result property="postContent" column="POST_CONTENT"/>
   	  <result property="postDate" column="POST_DATE"/>
   	  <result property="ansStatus" column="ANS_STATUS"/>
   	  <result property="queNo" column="QUE_NO"/>
   	  <result property="status" column="STATUS"/>
   </resultMap>

  
   <!-- 공지사항 게시글 수 조회 -->
   <select id="selectNoticeTotalCount" resultType="_int">
   	  SELECT
   	  	  COUNT(*)
   	  	 FROM POST_TBL A
   	  	<where>
   	  	  <if test='searchValue != null'>
   	  	   A.POST_TITLE LIKE '%' ||  #{ searchValue } || '%'
   	  	  </if>
   	  	  <if test="searchCondition == '전체'">
   	  	    A.BOARD_CODE IN('1','2','3','4','5')
   	  	  </if>
   	  	  <if test="searchCondition == '공지'">
   	  	   A.BOARD_CODE = '1'
   	  	  </if>
   	  	  <if test="searchCondition == '안내'">
   	  	   A.BOARD_CODE = '2'
   	  	  </if>
   	  	  <if test="searchCondition == '점검'">
   	  	   A.BOARD_CODE = '3'
   	  	  </if>
   	  	  <if test="searchCondition == '이벤트'">
   	  	   A.BOARD_CODE = '4'
   	  	  </if>
   	  	  <if test="searchCondition == '사업자'">
   	  	   A.BOARD_CODE = '5'
   	  	  </if>
   	  	</where>
   </select>
 
   <!-- 공지사항 리스트 조회  -->
   <select id="selectNoticeList" resultMap="PostResultMap">
	   SELECT
	    C.RNUM
	   ,C.POST_NO
	   ,C.BOARD_CODE
	   ,C.POST_TITLE
	   ,C.MEM_CODE
	   ,C.POST_CONTENT
	   ,C.POST_DATE
	   ,C.ANS_STATUS
	   ,C.QUE_NO
	   ,C.STATUS
	   FROM (SELECT
	            ROWNUM RNUM
	           ,B.POST_NO
	           ,B.BOARD_CODE
	           ,B.POST_TITLE
	           ,B.MEM_CODE
	           ,B.POST_CONTENT
	           ,B.POST_DATE
	           ,B.ANS_STATUS
	           ,B.QUE_NO
	           ,B.STATUS
	         FROM (SELECT
	                    A.POST_NO
	                   ,A.BOARD_CODE
	                   ,A.POST_TITLE
	                   ,A.MEM_CODE
	                   ,A.POST_CONTENT
	                   ,A.POST_DATE
	                   ,A.ANS_STATUS
	                   ,A.QUE_NO
	                   ,A.STATUS
	                   FROM POST_TBL A
	                  <where>
			   	  	  <if test='searchValue != null'>
			   	  	   A.POST_TITLE LIKE '%' ||  #{ searchValue } || '%'
			   	  	  </if>
			   	  	  <if test="searchCondition == '전체'">
			   	  	    A.BOARD_CODE IN('1','2','3','4','5')
			   	  	  </if>
			   	  	  <if test="searchCondition == '공지'">
			   	  	   A.BOARD_CODE = '1'
			   	  	  </if>
			   	  	  <if test="searchCondition == '안내'">
			   	  	   A.BOARD_CODE = '2'
			   	  	  </if>
			   	  	  <if test="searchCondition == '점검'">
			   	  	   A.BOARD_CODE = '3'
			   	  	  </if>
			   	  	  <if test="searchCondition == '이벤트'">
			   	  	   A.BOARD_CODE = '4'
			   	  	  </if>
			   	  	  <if test="searchCondition == '사업자'">
			   	  	   A.BOARD_CODE = '5'
			   	  	  </if>
			   	  	  </where>
	                  ORDER BY A.POST_DATE DESC)B
	          <![CDATA[        
	          WHERE ROWNUM <= #{ endRow }
	          ]]>)C
	   <![CDATA[
	  WHERE C.RNUM >= #{ startRow } 
       ]]>
   </select>
   
   <select id="idDupCheck" parameterType="string" resultType="int">
       SELECT 
       		  COUNT(*) 
       	 FROM MEMBER_TBL 
       	WHERE MEM_ID = #{ memId }
       	  AND IS_DELETED = 'N'
       	  AND MEM_TYPE = 'manager'
   </select>
</mapper>