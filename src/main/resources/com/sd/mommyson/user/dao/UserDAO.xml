<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    <mapper namespace="com.sd.mommyson.user.dao.UserDAO">
    
    <resultMap type="com.sd.mommyson.manager.dto.PostDTO" id="postResultMap">
    	<id property="postNo" column="POST_NO"/>
    	<result property="boardCode" column="BOARD_CODE"/>
    	<result property="postTitle" column="POST_TITLE"/>
    	<result property="memCode" column="MEM_CODE"/>
    	<result property="postContent" column="POST_CONTENT"/>
    	<result property="postDate" column="POST_DATE"/>
    	<result property="ansStatus" column="ANS_STATUS"/>
    	<result property="questionNo" column="QUE_NO"/>
    	<result property="status" column="STATUS"/>
    	<result property="viewCnt" column="VIEW_CNT"/>
    </resultMap>
    
    <resultMap type="com.sd.mommyson.member.dto.StoreDTO" id="storeResultMap">
    	<id property="memCode" column="MEM_CODE"/>
    	<result property="storeName" column="STORE_NAME"/>
    	<result property="storeImg" column="STORE_IMG"/>
    	<result property="storeInfo" column="STORE_INFO"/>
    	<result property="grade" column="GRADE"/>
    	<result property="delCost" column="DEL_COST"/>
    	<result property="workTime" column="WORK_TIME"/>
    	<result property="rvCount" column="COUNT"/>
    </resultMap>
    
    <resultMap type="com.sd.mommyson.user.dto.ReviewDTO" id="reviewResultMap">
    	<id property="rvCode" column="RV_CODE"/>
    	<result property="memCode" column="MEM_CODE"/>
    	<result property="orderCode" column="ORDER_CODE"/>
    	<result property="img" column="RV_IMG"/>
    	<result property="content" column="RV_CONTENT"/>
    	<result property="grade" column="RV_GRADE"/>
    	<result property="memId" column="MEM_ID"/>
    	<result property="isDeleted" column="IS_DELETED"/>
    	<collection property="orderList" ofType="java.lang.String" javaType="list">
    		<result column="SD_NAME"/>
    	</collection>
    </resultMap>
    
    <!-- 공지사항 출력 및 검색 -->
    <select id="selectNotice" resultMap="postResultMap">
    	SELECT
    	       A.RNUM	
    	     , A.POST_NO
			 , A.BOARD_CODE
			 , A.POST_TITLE
			 , A.MEM_CODE
			 , A.POST_CONTENT
			 , A.POST_DATE
			 , A.ANS_STATUS
			 , A.QUE_NO
			 , A.STATUS
			 , A.VIEW_CNT				
		FROM (SELECT ROWNUM RNUM	
				 , B.POST_NO
				 , B.BOARD_CODE
				 , B.POST_TITLE
				 , B.MEM_CODE
				 , B.POST_CONTENT
				 , B.POST_DATE
				 , B.ANS_STATUS
				 , B.QUE_NO
				 , B.STATUS
				 , B.VIEW_CNT	
			  FROM (SELECT C.POST_NO
						 , C.BOARD_CODE
						 , C.POST_TITLE
						 , C.MEM_CODE
						 , C.POST_CONTENT
						 , C.POST_DATE
						 , C.ANS_STATUS
						 , C.QUE_NO
						 , C.STATUS	
						 , C.VIEW_CNT
					  FROM POST_TBL C 
					  JOIN BOARD_TBL D ON (C.BOARD_CODE = D.BOARD_CODE)
						  <where>
							    C.STATUS = 'N'
							  <if test="searchCondition =='total' or searchCondition == null " >
							    AND D.TYPE = 'notice'
							  </if>	
							  <if test="searchCondition =='notice'">
							    AND D.TYPE = 'notice'
							  	AND D.D_TYPE = 'notice'
							  </if>
							  <if test="searchCondition =='guide'">
							    AND D.TYPE = 'notice'
							  	AND D.D_TYPE = 'guide'
							  </if>
							  <if test="searchCondition =='check'">
							    AND D.TYPE = 'notice'
							  	AND D.D_TYPE = 'check'
							  </if>
							  <if test="searchCondition =='event'">
							    AND D.TYPE = 'notice'
							  	AND D.D_TYPE = 'event'
							  </if>
							  <if test="searchCondition =='owner'">
							    AND D.TYPE = 'notice'
							  	AND D.D_TYPE = 'owner'
							  </if>
							  <if test="searchValue != null and searchValue !=''">
							   AND C.POST_TITLE LIKE '%' || #{ searchValue } || '%'
							  </if>
						  </where>
						  ORDER BY C.POST_NO DESC
						  ) B
					  <![CDATA[
					  WHERE ROWNUM <= #{ endRow }
					  ]]>
					  ) A
					JOIN BOARD_TBL D ON (A.BOARD_CODE = D.BOARD_CODE)  
		 	   WHERE A.RNUM >= #{ startRow }	
    
    </select>
    
    <resultMap type="com.sd.mommyson.owner.dto.ProductDTO" id="productResultMap">
    	<id property="sdCode" column="SD_CODE"/>
    	<result property="sdName" column="SD_NAME"/>
    	<result property="mDate" column="M_DATE"/>
    	<result property="price" column="PRICE"/>
    	<result property="ingredient" column="INGREDIENT"/>
    	<result property="volume" column="VOLUME"/>
    	<result property="sdImg" column="SD_IMG"/>
    	<result property="category" column="CATEGORY"/>
    	<result property="discountRate" column="DISCOUNT_RATE"/>
    	<result property="memCode" column="MEM_CODE"/>
    	<result property="orderableStatus" column="ORDERABLE_STATUS"/>
    	<result property="eDate" column="EXPIRY_DATE"/>
    	<result property="categoryCode" column="CATEGORY_CODE"/>
    	<result property="storageMethod" column="STORAGE_METHOD"/>
    	<result property="detail" column="SD_DETAIL"/>
    	<result property="isDeleted" column="IS_DELETED"/>
    	<result property="storeName" column="STORE_NAME"/>
    </resultMap>
    
    <resultMap type="com.sd.mommyson.owner.dto.ProductDTO" id="productTagResultMap">
    	<id property="sdCode" column="SD_CODE"/>
    	<result property="sdName" column="SD_NAME"/>
    	<result property="mDate" column="M_DATE"/>
    	<result property="price" column="PRICE"/>
    	<result property="ingredient" column="INGREDIENT"/>
    	<result property="volume" column="VOLUME"/>
    	<result property="sdImg" column="SD_IMG"/>
    	<result property="category" column="CATEGORY"/>
    	<result property="discountRate" column="DISCOUNT_RATE"/>
    	<result property="memCode" column="MEM_CODE"/>
    	<result property="orderableStatus" column="ORDERABLE_STATUS"/>
    	<result property="eDate" column="EXPIRY_DATE"/>
    	<result property="categoryCode" column="CATEGORY_CODE"/>
    	<result property="storageMethod" column="STORAGE_METHOD"/>
    	<result property="detail" column="SD_DETAIL"/>
    	<result property="isDeleted" column="IS_DELETED"/>
    	<result property="storeName" column="STORE_NAME"/>
    	<collection property="tagList" ofType="java.lang.String" javaType="list">
    		<result column="TAG"/>
    	</collection>
    </resultMap>

    <!-- 공지사항  페이지수  -->
    <select id="selectTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
               COUNT(*)
          FROM POST_TBL A
	      JOIN BOARD_TBL B ON(A.BOARD_CODE = B.BOARD_CODE)
    	<where>
			A.STATUS = 'N'
			AND B.TYPE ='notice'
    		<if test="searchCondition != null and searchCondition != '' and searchCondition != 'total' ">
				AND B.D_TYPE = #{ searchCondition }
    		</if>
			<if test="searchValue != null">
	        	AND A.POST_TITLE LIKE '%' || #{ searchValue } || '%' 	
			</if>
    	</where>
	</select>
	
	<!-- FQA 페이지 네이션수 -->
	 <!-- 공지사항  페이지수  -->
    <select id="selectFqaTotalCount" resultType="_int" parameterType="hashmap">
        SELECT
               COUNT(*)
          FROM POST_TBL A
	      JOIN BOARD_TBL B ON(A.BOARD_CODE = B.BOARD_CODE)
    	<where>
			A.STATUS = 'N'
			AND B.TYPE ='fqa'
    		<if test="searchCondition != null and searchCondition != '' and searchCondition != 'total' ">
				AND B.D_TYPE = #{ searchCondition }
    		</if>
			<if test="searchValue != null">
	        	AND A.POST_TITLE LIKE '%' || #{ searchValue } || '%' 	
			</if>
    	</where>
	</select>
	
	<select id="selectStoreTotalCount" parameterType="hashmap" resultType="_int">
		SELECT
			   COUNT(*)
		  FROM CEO_TBL A
		  LEFT JOIN MEMBER_TBL B ON(A.MEM_CODE = B.MEM_CODE)
		  LEFT JOIN STORE_TBL C ON(A.MEM_CODE = C.MEM_CODE)
		 WHERE B.IS_DELETED = 'N'
		 <if test="type == 'new'">
		   AND B.ENROLL_DATE > (SYSDATE - 100)
		 </if>
		 <if test="searchValue != null">
		   AND C.STORE_NAME LIKE '%' || #{ searchValue } || '%'
		 </if>
	</select>
	<!-- 공지사항 내용 출력  -->
	<select id="selectNoticeContents" resultMap="postResultMap">
		SELECT
			   A.POST_NO
			 , A.BOARD_CODE
			 , A.POST_TITLE
			 , A.MEM_CODE
			 , A.POST_CONTENT
			 , A.POST_DATE
			 , A.ANS_STATUS
			 , A.QUE_NO
			 , A.STATUS
			 , A.VIEW_CNT
		 FROM POST_TBL A	 
		WHERE A.POST_NO = #{ postNo }			 
	</select>
	
	<!--공지사항 조회수  증가 -->
	<update id="updateincrementNoticeBoardCount">
        UPDATE 
               POST_TBL A
           SET A.VIEW_CNT = (SELECT B.VIEW_CNT
                                  FROM POST_TBL B
                                 WHERE B.POST_NO = #{ postNo }
                               ) + 1
         WHERE A.POST_NO = #{ postNo }
	</update>
	
	<!-- 중요공지사항 출력 -->
	<select id="selectImportantNotice" resultMap="postResultMap">
	SELECT 
		   A.POST_NO
		 , A.BOARD_CODE
		 , A.POST_TITLE
		 , A.MEM_CODE
		 , A.POST_CONTENT
		 , A.POST_DATE
		 , A.ANS_STATUS
		 , A.QUE_NO
		 , A.STATUS
		 , A.VIEW_CNT
	  FROM POST_TBL A
	  JOIN BOARD_TBL B ON(B.BOARD_CODE = A.BOARD_CODE)
	 WHERE A.STATUS LIKE 'U'
	</select>
	
	<!-- 자주하는 질문 -->
	<select id="selectFqaList" resultMap="postResultMap">
    	SELECT
    	       A.RNUM	
    	     , A.POST_NO
			 , A.BOARD_CODE
			 , A.POST_TITLE
			 , A.MEM_CODE
			 , A.POST_CONTENT
			 , A.POST_DATE
			 , A.ANS_STATUS
			 , A.QUE_NO
			 , A.STATUS				
		FROM (SELECT ROWNUM RNUM	
				 , B.POST_NO
				 , B.BOARD_CODE
				 , B.POST_TITLE
				 , B.MEM_CODE
				 , B.POST_CONTENT
				 , B.POST_DATE
				 , B.ANS_STATUS
				 , B.QUE_NO
				 , B.STATUS	
			  FROM (SELECT C.POST_NO
						 , C.BOARD_CODE
						 , C.POST_TITLE
						 , C.MEM_CODE
						 , C.POST_CONTENT
						 , C.POST_DATE
						 , C.ANS_STATUS
						 , C.QUE_NO
						 , C.STATUS	
					  FROM POST_TBL C 
					  JOIN BOARD_TBL D ON (C.BOARD_CODE = D.BOARD_CODE)
						  <where>
						  	D.TYPE = 'fqa'
							AND C.STATUS = 'N' 
							  <if test="searchCondition =='memberJoinQuestion'">
							  	AND D.D_TYPE = 'memberJoinQuestion'
							  </if>
							  <if test="searchCondition =='billAndOrderQuestion'">
							  	AND D.D_TYPE = 'billAndOrderQuestion'
							  </if>
							  <if test="searchCondition =='reviewManagementQuestion'">
							  	AND D.D_TYPE = 'reviewManagementQuestion'
							  </if>
							  <if test="searchCondition =='userQuestion'">
							  	AND D.D_TYPE = 'userQuestion'
							  </if>
							  <if test="searchCondition =='inconvenienceQuestion'">
							  	AND D.D_TYPE = 'inconvenienceQuestion'
							  </if>
							  <if test="searchCondition =='etcQuestion'">
							  	AND D.D_TYPE = 'etcQuestion'
							  </if>
							  <if test="searchValue != null and searchValue !=''">
							   AND C.POST_TITLE LIKE '%' || #{ searchValue } || '%'
							  </if>
						  </where>
						  ORDER BY C.POST_NO DESC
						  ) B
					  <![CDATA[
					  WHERE ROWNUM <= #{ endRow }
					  ]]>
					  ) A
				JOIN BOARD_TBL D ON (A.BOARD_CODE = D.BOARD_CODE)	  
		 	   WHERE A.RNUM >= #{ startRow }	
    </select>
	 
    
    <select id="selectStoreList" resultMap="storeResultMap">
    	SELECT
		       C.RNUM
		     , C.MEM_CODE
		     , C.STORE_NAME
		     , C.STORE_IMG
		     , C.COUNT
	     FROM (SELECT
		              ROWNUM RNUM
		            , B.MEM_CODE
	                , B.STORE_NAME
	                , B.STORE_IMG 
	                , B.COUNT 
	            FROM (SELECT
	                         A.MEM_CODE
	                       , A.STORE_NAME
	                       , A.STORE_IMG 
	                       , (SELECT COUNT(*) FROM STORE_TBL S LEFT JOIN REVIEW_TBL R ON(S.MEM_CODE = R.MEM_CODE)) AS COUNT
	                    FROM STORE_TBL A
	                    LEFT JOIN MEMBER_TBL M ON(A.MEM_CODE = M.MEM_CODE)
	                    <where>
	                    	M.IS_DELETED = 'N'
				         	<if test='searchValue != null'>
				         	A.POST_TITLE LIKE '%' ||  #{ searchValue } || '%'
				         	</if>
			   	        </where>
	                    <if test="searchCondition == 'new'">
	                    	ORDER BY M.ENROLL_DATE DESC
	                    </if>
	                    <if test="searchCondition == 'famous'">
	                    	ORDER BY (SELECT COUNT(*) FROM STORE_TBL S LEFT JOIN REVIEW_TBL R ON(S.MEM_CODE = R.MEM_CODE)) DESC
	                    </if>
	                    )B
	          <![CDATA[        
	          WHERE ROWNUM <= #{ endRow }
	          ]]>)C
	   <![CDATA[
	  WHERE C.RNUM >= #{ startRow } 
       ]]>
    </select>
    
    <select id="selectProductTotalCount" parameterType="hashmap" resultType="_int">
    	SELECT
			   COUNT(*)
		  FROM PRODUCT_TBL A
		 WHERE A.IS_DELETED = 'N'
		   AND A.ORDERABLE_STATUS = 'Y'
		 <if test="category != 'recommend' and category != null">
		   AND A.CATEGORY_CODE = #{ category } 
		 </if>
		 <if test="category == 'recommend' and category != null">
		   AND A.RECOMMEND_YN = 'Y'
		 </if>
		 <if test="searchValue != null">
		   AND A.SD_NAME LIKE '%' || #{ searchValue } || '%'
		 </if>
		 <if test="searchCondition != null">
		   AND A.DISCOUNT_RATE > 0
		 </if>
    </select>
    
    <select id="selectProductList" resultMap="productResultMap">
    	SELECT
		       C.RNUM
		     , C.SD_CODE
             , C.SD_NAME
             , C.PRICE
             , C.VOLUME 
             , C.SD_IMG 
             , C.CATEGORY 
             , C.DISCOUNT_RATE 
             , C.MEM_CODE
             , C.STORE_NAME
	     FROM (SELECT
		              ROWNUM RNUM
		            , B.SD_CODE
	                , B.SD_NAME
	                , B.PRICE
	                , B.VOLUME 
                    , B.SD_IMG 
                    , B.CATEGORY 
                    , B.DISCOUNT_RATE 
                    , B.MEM_CODE 
                    , B.STORE_NAME 
	            FROM (SELECT
	                         A.SD_CODE
	                       , A.SD_NAME
	                       , A.PRICE 
	                       , A.VOLUME 
	                       , A.SD_IMG 
	                       , A.CATEGORY 
	                       , A.DISCOUNT_RATE 
	                       , A.MEM_CODE 
	                       , S.STORE_NAME
	                    FROM PRODUCT_TBL A
	                    LEFT JOIN MEMBER_TBL M ON(A.MEM_CODE = M.MEM_CODE)
	                    LEFT JOIN STORE_TBL S ON(A.MEM_CODE = S.MEM_CODE)
	                    <where>
	                    	M.IS_DELETED = 'N'
	                    	AND A.ORDERABLE_STATUS = 'Y'
				         	<if test='searchValue != null'>
				         	AND A.SD_NAME LIKE '%' ||  #{ searchValue } || '%'
				         	</if>
		                    <if test="searchCondition == 'recommend'">
		                    AND A.RECOMMEND_YN = 'Y'
		                    </if>
		                    <if test="searchCondition != 'recommend' and searchCondition != 'sale'">
		                    AND A.CATEGORY_CODE = #{ searchCondition }
		                    </if>
		                    <if test="searchCondition == 'sale'">
							AND A.DISCOUNT_RATE > 0
							</if>
			   	        </where>
	                    )B
	          <![CDATA[        
	          WHERE ROWNUM <= #{ endRow }
	          ]]>)C
	   <![CDATA[
	  WHERE C.RNUM >= #{ startRow } 
       ]]>
    </select>
    
    <select id="selectStoreMyMemCode" resultType="hashmap">
    	SELECT
    		   A.MEM_CODE
    		 , A.PHONE 
    		 , B.STORE_IMG
    		 , B.STORE_NAME
    		 , B.GRADE
    		 , (SELECT COUNT(*) FROM JJIM_TBL C WHERE C.MEM_CODE = #{ memCode }) AS JJIM
    	  FROM MEMBER_TBL A
    	  LEFT JOIN STORE_TBL B ON(A.MEM_CODE = B.MEM_CODE)
    	 WHERE A.MEM_CODE = #{ memCode }
    </select>
    
    <select id="selectReviewList" resultMap="reviewResultMap">
    	SELECT
		       C.RNUM
		     , C.MEM_CODE
             , C.RV_IMG
             , C.RV_CONTENT
             , C.RV_GRADE 
             , C.RV_CODE 
             , C.MEM_ID 
             , C.SD_NAME 
	     FROM (SELECT
		              ROWNUM RNUM
		            , B.MEM_CODE
	                , B.RV_IMG
	                , B.RV_CONTENT
	                , B.RV_GRADE 
                    , B.RV_CODE 
                    , B.MEM_ID 
                    , B.SD_NAME 
	            FROM (SELECT
	                         A.MEM_CODE
	                       , A.RV_IMG
	                       , A.RV_CONTENT
	                       , A.RV_GRADE
	                       , A.RV_CODE
	                       , A.MEM_ID 
	                       , P.SD_NAME
	                    FROM REVIEW_TBL A
	                    LEFT JOIN ORDER_INFO_TBL O ON(A.ORDER_CODE = O.ORDER_CODE)
						JOIN PRODUCT_TBL P ON(O.SD_CODE = P.SD_CODE)
	                    <where>
	                    	A.IS_DELETED = 'N'
	                    	<if test="searchCondition != null ">
		                    AND P.MEM_CODE = #{ searchCondition }
		                    </if>
			   	        </where>
	                    )B
	          <![CDATA[
	          WHERE ROWNUM <= #{ endRow }
	          ]]>)C
	   <![CDATA[
	  WHERE C.RNUM >= #{ startRow } 
       ]]>
    </select>
    
    <select id="selectReviewTotalCount" parameterType="hashmap" resultType="_int">
    	SELECT
			   COUNT(*)
		  FROM REVIEW_TBL A
		  JOIN ORDER_INFO_TBL B ON(A.ORDER_CODE = B.ORDER_CODE)
		  JOIN PRODUCT_TBL C ON(B.SD_CODE = C.SD_CODE)
		 WHERE A.IS_DELETED = 'N'
		 <if test="memCode != null">
		   AND C.MEM_CODE = #{ memCode }
		 </if>
    </select>
    
    <select id="selectProducts" resultMap="productResultMap">
    	SELECT
    		   A.SD_CODE
    		 , A.SD_IMG
    		 , A.SD_NAME
    		 , A.SD_DETAIL
    		 , A.DISCOUNT_RATE
    		 , A.PRICE
    		 , A.ORDERABLE_STATUS
    	  FROM PRODUCT_TBL A
    	 WHERE A.IS_DELETED = 'N'
    	   AND A.MEM_CODE = #{ memCode }
    </select>
    
    <select id="selectProductBySdCode" resultMap="productTagResultMap">
    	SELECT
    		   A.SD_CODE
    		 , A.SD_IMG
    		 , A.M_DATE
    		 , A.EXPIRY_DATE
    		 , A.VOLUME
    		 , A.DISCOUNT_RATE
    		 , A.CATEGORY
    		 , A.STORAGE_METHOD
    		 , A.INGREDIENT
    		 , A.SD_NAME
    		 , A.SD_DETAIL
    		 , A.DISCOUNT_RATE
    		 , A.PRICE
    		 , A.ORDERABLE_STATUS
    		 , C.TAG
    	  FROM PRODUCT_TBL A
    	  LEFT JOIN PRODUCT_TAG_TBL B ON(A.SD_CODE = B.SD_CODE)
    	  JOIN TAGS_TBL C ON(B.TAG_NO = C.TAG_NO)
    	 WHERE A.IS_DELETED = 'N'
    	   AND A.SD_CODE = #{ sdCode }
    </select>
    
    <insert id="insertShoppingBasket">
    	INSERT
    	INTO CART_TBL
    	VALUES
    	(
    	  #{ memCode }
    	, #{ sdCode }
    	, #{ amount }
    	, SEQ_CART.NEXTVAL
    	)
    </insert>
    
    <insert id="insertReport">
    	INSERT
    	INTO REPORT_TBL
    	VALUES
    	(
    	  #{ rvCode }
    	, #{ reportType }
    	, SEQ_PREPORT.NEXTVAL
    	, SYSDATE
    	, DEFAULT
    	)
    </insert>
    </mapper>